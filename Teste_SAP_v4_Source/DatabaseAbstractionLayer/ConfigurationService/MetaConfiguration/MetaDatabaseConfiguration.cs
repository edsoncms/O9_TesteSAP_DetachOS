/* 
 This source code (the "Generated Software") is generated by the OutSystems Platform 
 and is licensed by OutSystems (http://www.outsystems.com) to You solely for testing and evaluation 
 purposes, unless You and OutSystems have executed a specific agreement covering the use terms and 
 conditions of the Generated Software, in which case such agreement shall apply. 
*/

using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using OutSystems.RuntimeCommon;

namespace OutSystems.HubEdition.Extensibility.Data.ConfigurationService.MetaConfiguration {
    /// <summary>
    /// Represents the meta-information about a database configuration.
    /// </summary>
    public class MetaDatabaseConfiguration {
        private readonly object configuration;
        private readonly IList<IParameter> parameters;

        public MetaDatabaseConfiguration(object configuration) {
            this.configuration = configuration;
            parameters = FindParameters();
        }

        private IList<IParameter> FindParameters() {
            IDictionary<string, IParameter> results = new Dictionary<string, IParameter>();
            Type type = configuration.GetType();
            for (Type t = type; t != null; t = t.BaseType) {
                foreach (PropertyInfo prop in t.GetProperties()) {
                    Attribute param = GetConfigurationParameter(prop);
                    if (param != null && !results.ContainsKey(prop.Name)) {
                        results.Add(prop.Name, GetParameterToAdd(param, prop));
                    }
                }
            }
            return results.Values.ToList();
        }

        private static Attribute GetConfigurationParameter(PropertyInfo prop) {
            var attrs = (ConfigurationParameter[]) prop.GetCustomAttributes(typeof (ConfigurationParameter), false);
            return attrs.Length == 0 ? null : attrs[0];
        }

        private static Attribute[] GetHelpLinksForEnum(PropertyInfo prop) {
            return (HelpLinkForEnumConfigurationParameter[]) prop.GetCustomAttributes(typeof (HelpLinkForEnumConfigurationParameter), false);
        }

        private Parameter GetParameterToAdd(Attribute param, PropertyInfo prop) {
            
            string propName = prop.Name;

            
            MethodInfo getter = prop.GetGetMethod();

            
            MethodInfo setter = prop.GetSetMethod();


            var userDefinedConfigParam = param as UserDefinedConfigurationParameter;
            if (userDefinedConfigParam != null) {
                MethodInfo visibilityChecker = null;
                if (!string.IsNullOrEmpty(userDefinedConfigParam.VisibilityChecker)) {
                    visibilityChecker = configuration.GetType().GetMethod(userDefinedConfigParam.VisibilityChecker);
                }
#if !JAVA
                if (prop.PropertyType.IsEnum) {

                    Dictionary<String, KeyValuePair<String, String>> helpInfo = null;

                    foreach (HelpLinkForEnumConfigurationParameter help in GetHelpLinksForEnum(prop)) {
                        if (helpInfo == null) {
                            helpInfo = new Dictionary<string, KeyValuePair<string, string>>();
                        }
                        helpInfo.Add(help.EnumValue, new KeyValuePair<string, string>(help.Text, help.Url));
                    }
                    return new UserChosenOptionParameter(propName, getter, setter, configuration, userDefinedConfigParam.Encrypt, userDefinedConfigParam.Persist, visibilityChecker, userDefinedConfigParam, helpInfo);
                }
#endif
                return new UserDefinedParameter(propName, getter, setter, configuration, userDefinedConfigParam.Encrypt, userDefinedConfigParam.Persist, visibilityChecker, userDefinedConfigParam);
            }

            var configParam = (ConfigurationParameter) param;
            return new Parameter(propName, getter, setter, configParam.Encrypt, configParam.Persist, configuration);
        }

        /// <summary>
        /// Returns a parameter with the given name.
        /// </summary>
        ///
        /// <param name="name">The parameter's name.</param>
        ///
        /// <returns>A parameter with the given name.</returns>
        public IParameter GetParameter(string name) {

            Func<IParameter, bool> matchesName = p => p.Name.Equals(name);

            return Parameters.FirstOrDefault(matchesName) ??
                   AdvancedModeParameters().Cast<IParameter>().FirstOrDefault(matchesName);
        }

        public string GetOrElse(string name, string orElse) {
            var param = GetParameter(name);
            if (param != null) {
                return param.Get();
            } else {
                return orElse;
            }
        }

        private IEnumerable<IUserDefinedParameter> AdvancedModeParameters() {

            var integrationConf = configuration as IIntegrationDatabaseConfiguration;
            if (integrationConf == null) yield break;
            yield return new AdvancedConnectionStringParam(integrationConf);
            yield return new ConnStringTemplateParam(integrationConf);
        }

        public string this[string pname] {
            get { return GetParameter(pname).Get(); }
            set { GetParameter(pname).Set(value); }
        }

        /// <summary>
        /// Gets a list of visible parameters.
        /// </summary>
        ///
        /// <value>The list of visible parameters.</value>
        public IList<IUserDefinedParameter> VisibleParameters {
            get {
                if (configuration is IIntegrationDatabaseConfiguration &&  ((IIntegrationDatabaseConfiguration) configuration).AdvancedConfiguration.IsSet()) {
                    return parameters
                        .OfType<IUserDefinedParameter>()
                        .Where(p => p.Visible && p.Region == ParameterRegion.UserSpecific)
                        .Union(AdvancedModeParameters().Where(p => p.Visible))
                        .ToList();
                } 
                return parameters.OfType<IUserDefinedParameter>().Where(p => p.Visible).ToList();
            }
        }

        public IList<IParameter> PersistableParameters {
            get {
                return parameters.Where(p => p.Persist).ToList();
            }
        }

        /// <summary>
        /// Gets a list of all parameters.
        /// </summary>
        ///
        /// <value>The list of parameters.</value>
        public IList<IParameter> Parameters {
            get {
                return parameters;
            }
        }
    }
}
